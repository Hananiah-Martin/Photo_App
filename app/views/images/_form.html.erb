<%= form_with(model: image) do |form| %>
  
  <%# 1. Error Messages Section %>
  <% if image.errors.any? %>
    <div class="alert alert-danger shadow-sm border-0 mb-4" role="alert">
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <h5 class="alert-heading mb-0 fw-bold">
          <%= pluralize(image.errors.count, "error") %> prevented this save:
        </h5>
      </div>
      <ul class="mb-0 small">
        <% image.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# 2. Image Name Field %>
  <div class="mb-4">
    <%= form.label :name, "Title or Description", class: "form-label fw-bold" %>
    <div class="input-group">
      <span class="input-group-text bg-white"><i class="bi bi-pencil text-muted"></i></span>
      <%= form.text_field :name, 
                         class: "form-control", 
                         placeholder: "Give your image a name...",
                         required: true %>
    </div>
  </div>

  <%# 3. Picture Upload Field %>
  <div class="mb-4">
    <%= form.label :picture, "Select Image", class: "form-label fw-bold" %>
    <%= form.file_field :picture,
                        id: "image_upload_input",
                        class: "form-control", 
                        accept: 'image/png,image/gif,image/jpeg' %>
    
    <%# Show existing image thumbnail if editing %>
    <% if image.picture.attached? && image.persisted? %>
      <div class="mt-3">
        <p class="small text-muted mb-1">Current Image:</p>
        <%= image_tag image.picture, class: "img-thumbnail", style: "height: 100px; width: 100px; object-fit: cover;" %>
      </div>
    <% end %>
  </div>

  <%# 4. Hidden User ID (Safety) %>
  <%# We remove the text_field so users can't edit it %>
  <%= form.hidden_field :user_id, value: current_user.id %>

  <%# 5. Submit Button %>
  <div class="d-grid mt-2">
    <%= form.submit class: "btn btn-primary btn-lg shadow-sm" %>
  </div>

<% end %>
<script>
  document.querySelector('#image_upload_input').addEventListener('change', function() {
    const sizeInMB = (this.files[0].size / (1024 * 1024)).toFixed(2);
    const flashContainer = document.querySelector('#flash-messages');

    if (sizeInMB > 1) {
      // Create a Bootstrap Alert dynamically
      flashContainer.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show shadow-sm">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          File size (${sizeInMB} MB) is too large. Max is 1 MB.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      this.value = ""; // Clear the file input
    } else {
      flashContainer.innerHTML = ""; // Clear message if file is okay
    }
  });
</script>